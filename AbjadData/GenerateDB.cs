using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace AbjadData
{
    public class GenerateDB
    {

            public static bool GenerateScript()
            {
                // Query to check if DB exists
                string query = "SELECT 1 FROM sys.databases WHERE name = N'Abjad'";

                // Script to create the database
                string createDbScript = "CREATE DATABASE [Abjad]\r\n CONTAINMENT = NONE\r\n ON  PRIMARY \r\n( NAME = N'Abjad', FILENAME = N'C:\\Program Files\\Microsoft SQL Server\\MSSQL16.MSSQLSERVER\\MSSQL\\DATA\\Abjad.mdf' , SIZE = 8192KB , MAXSIZE = UNLIMITED, FILEGROWTH = 65536KB )\r\n LOG ON \r\n( NAME = N'Abjad_log', FILENAME = N'C:\\Program Files\\Microsoft SQL Server\\MSSQL16.MSSQLSERVER\\MSSQL\\DATA\\Abjad_log.ldf' , SIZE = 8192KB , MAXSIZE = 2048GB , FILEGROWTH = 65536KB )\r\n WITH CATALOG_COLLATION = DATABASE_DEFAULT, LEDGER = OFF\r\nGO\r\nALTER DATABASE [Abjad] SET COMPATIBILITY_LEVEL = 160\r\nGO\r\nIF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))\r\nbegin\r\nEXEC [Abjad].[dbo].[sp_fulltext_database] @action = 'enable'\r\nend\r\nGO\r\nALTER DATABASE [Abjad] SET ANSI_NULL_DEFAULT OFF \r\nGO\r\nALTER DATABASE [Abjad] SET ANSI_NULLS OFF \r\nGO\r\nALTER DATABASE [Abjad] SET ANSI_PADDING OFF \r\nGO\r\nALTER DATABASE [Abjad] SET ANSI_WARNINGS OFF \r\nGO\r\nALTER DATABASE [Abjad] SET ARITHABORT OFF \r\nGO\r\nALTER DATABASE [Abjad] SET AUTO_CLOSE OFF \r\nGO\r\nALTER DATABASE [Abjad] SET AUTO_SHRINK OFF \r\nGO\r\nALTER DATABASE [Abjad] SET AUTO_UPDATE_STATISTICS ON \r\nGO\r\nALTER DATABASE [Abjad] SET CURSOR_CLOSE_ON_COMMIT OFF \r\nGO\r\nALTER DATABASE [Abjad] SET CURSOR_DEFAULT  GLOBAL \r\nGO\r\nALTER DATABASE [Abjad] SET CONCAT_NULL_YIELDS_NULL OFF \r\nGO\r\nALTER DATABASE [Abjad] SET NUMERIC_ROUNDABORT OFF \r\nGO\r\nALTER DATABASE [Abjad] SET QUOTED_IDENTIFIER OFF \r\nGO\r\nALTER DATABASE [Abjad] SET RECURSIVE_TRIGGERS OFF \r\nGO\r\nALTER DATABASE [Abjad] SET  ENABLE_BROKER \r\nGO\r\nALTER DATABASE [Abjad] SET AUTO_UPDATE_STATISTICS_ASYNC OFF \r\nGO\r\nALTER DATABASE [Abjad] SET DATE_CORRELATION_OPTIMIZATION OFF \r\nGO\r\nALTER DATABASE [Abjad] SET TRUSTWORTHY OFF \r\nGO\r\nALTER DATABASE [Abjad] SET ALLOW_SNAPSHOT_ISOLATION OFF \r\nGO\r\nALTER DATABASE [Abjad] SET PARAMETERIZATION SIMPLE \r\nGO\r\nALTER DATABASE [Abjad] SET READ_COMMITTED_SNAPSHOT OFF \r\nGO\r\nALTER DATABASE [Abjad] SET HONOR_BROKER_PRIORITY OFF \r\nGO\r\nALTER DATABASE [Abjad] SET RECOVERY FULL \r\nGO\r\nALTER DATABASE [Abjad] SET  MULTI_USER \r\nGO\r\nALTER DATABASE [Abjad] SET PAGE_VERIFY CHECKSUM  \r\nGO\r\nALTER DATABASE [Abjad] SET DB_CHAINING OFF \r\nGO\r\nALTER DATABASE [Abjad] SET FILESTREAM( NON_TRANSACTED_ACCESS = OFF ) \r\nGO\r\nALTER DATABASE [Abjad] SET TARGET_RECOVERY_TIME = 60 SECONDS \r\nGO\r\nALTER DATABASE [Abjad] SET DELAYED_DURABILITY = DISABLED \r\nGO\r\nALTER DATABASE [Abjad] SET ACCELERATED_DATABASE_RECOVERY = OFF  \r\nGO\r\nEXEC sys.sp_db_vardecimal_storage_format N'Abjad', N'ON'\r\nGO\r\nALTER DATABASE [Abjad] SET QUERY_STORE = ON\r\nGO\r\nALTER DATABASE [Abjad] SET QUERY_STORE (OPERATION_MODE = READ_WRITE, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 30), DATA_FLUSH_INTERVAL_SECONDS = 900, INTERVAL_LENGTH_MINUTES = 60, MAX_STORAGE_SIZE_MB = 1000, QUERY_CAPTURE_MODE = AUTO, SIZE_BASED_CLEANUP_MODE = AUTO, MAX_PLANS_PER_QUERY = 200, WAIT_STATS_CAPTURE_MODE = ON)\r\nGO";
                // Script to run after creation inside the new database
                string postCreationScript = "\r\n\r\n/****** Object:  UserDefinedFunction [dbo].[FCT_GetClientsTotal]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\ncreate function [dbo].[FCT_GetClientsTotal]()\r\nreturns int\r\nas\r\nbegin\r\nreturn (select count(1) from Clients)\r\nend\r\nGO\r\n/****** Object:  UserDefinedFunction [dbo].[FCT_GetItemsTotal]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE Function [dbo].[FCT_GetItemsTotal](@categoryid int,@name nvarchar(50))\r\nreturns int\r\nas\r\nbegin\r\n return (select count(1) from items where (CategoryID=@categoryid or @categoryid=0) and name like '%'+@name+'%')\r\nend\r\nGO\r\n/****** Object:  UserDefinedFunction [dbo].[FCT_GetOrdersTotal]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\ncreate Function [dbo].[FCT_GetOrdersTotal](@ClientID int)\r\nreturns int\r\nas\r\nbegin\r\n return (select count(1) from orders where @ClientID=-1 or ClientID=@ClientID)\r\nend\r\nGO\r\n/****** Object:  UserDefinedFunction [dbo].[FCT_UsernameExists]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\ncreate function [dbo].[FCT_UsernameExists](@Username nvarchar(50))\r\nreturns bit\r\nas\r\nbegin\r\nreturn (select 1 from Clients where Username=@Username)\r\nend\r\nGO\r\n/****** Object:  Table [dbo].[OrderDetails]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE TABLE [dbo].[OrderDetails](\r\n\t[OrderDetailID] [int] IDENTITY(1,1) NOT NULL,\r\n\t[OrderID] [int] NOT NULL,\r\n\t[ItemID] [int] NOT NULL,\r\n\t[Quantity] [int] NOT NULL,\r\n\t[TotalPrice] [smallmoney] NOT NULL,\r\n CONSTRAINT [PK__OrderDet__D3B9D30C54C05111] PRIMARY KEY CLUSTERED \r\n(\r\n\t[OrderDetailID] ASC\r\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]\r\n) ON [PRIMARY]\r\nGO\r\n/****** Object:  Table [dbo].[Items]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE TABLE [dbo].[Items](\r\n\t[ItemID] [int] IDENTITY(1,1) NOT NULL,\r\n\t[CategoryID] [int] NULL,\r\n\t[Name] [nvarchar](50) NOT NULL,\r\n\t[Description] [nvarchar](max) NOT NULL,\r\n\t[ImagePath] [nvarchar](max) NOT NULL,\r\n\t[Price] [smallmoney] NOT NULL,\r\n\t[Stock] [int] NOT NULL,\r\n\t[Discount] [decimal](3, 2) NOT NULL,\r\n CONSTRAINT [PK__Items__727E83EBE1659002] PRIMARY KEY CLUSTERED \r\n(\r\n\t[ItemID] ASC\r\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]\r\n) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]\r\nGO\r\n/****** Object:  UserDefinedFunction [dbo].[FCT_ListLatestAndTopSellingItems]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\ncreate function [dbo].[FCT_ListLatestAndTopSellingItems]()\r\nreturns table as\r\nreturn\r\n\r\nwith LatestItems as\r\n(\r\nselect top 3 * from Items order by ItemID desc\r\n),\r\n\r\n\r\nCountItems as\r\n(\r\nselect itemid,count(1) as Count from OrderDetails group by ItemID\r\n),\r\n\r\n\r\nTopSellingItems as\r\n(\r\nselect top 3 i.* from items i join countitems c on i.ItemID=c.itemid order by count desc\r\n\r\n)\r\n\r\nselect * from LatestItems union all  select * from TopSellingItems\r\n\r\n\r\nGO\r\n/****** Object:  Table [dbo].[Categories]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE TABLE [dbo].[Categories](\r\n\t[CategoryID] [int] IDENTITY(1,1) NOT NULL,\r\n\t[Name] [nvarchar](50) NOT NULL,\r\nPRIMARY KEY CLUSTERED \r\n(\r\n\t[CategoryID] ASC\r\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]\r\n) ON [PRIMARY]\r\nGO\r\n/****** Object:  Table [dbo].[Clients]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE TABLE [dbo].[Clients](\r\n\t[ClientID] [int] IDENTITY(1,1) NOT NULL,\r\n\t[FullName] [nvarchar](50) NOT NULL,\r\n\t[Address] [text] NOT NULL,\r\n\t[Username] [nvarchar](30) NOT NULL,\r\n\t[Password] [nvarchar](max) NOT NULL,\r\n\t[CreditCardNumber] [nvarchar](max) NOT NULL,\r\n\t[ImagePath] [nvarchar](max) NOT NULL,\r\n\t[IsActive] [bit] NOT NULL,\r\n CONSTRAINT [PK__Clients__E67E1A04E62063A1] PRIMARY KEY CLUSTERED \r\n(\r\n\t[ClientID] ASC\r\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]\r\n) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]\r\nGO\r\n/****** Object:  Table [dbo].[Orders]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE TABLE [dbo].[Orders](\r\n\t[OrderID] [int] IDENTITY(1,1) NOT NULL,\r\n\t[ClientID] [int] NOT NULL,\r\n\t[Date] [datetime] NOT NULL,\r\nPRIMARY KEY CLUSTERED \r\n(\r\n\t[OrderID] ASC\r\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]\r\n) ON [PRIMARY]\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Categories] ON \r\nGO\r\nINSERT [dbo].[Categories] ([CategoryID], [Name]) VALUES (1, N'Clothing')\r\nGO\r\nINSERT [dbo].[Categories] ([CategoryID], [Name]) VALUES (2, N'Electronics')\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Categories] OFF\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Clients] ON \r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (1, N'Mohammad Anani', N'old red cross road,Harkous', N'mohammad2006', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N't0aenMuLOHm7c+UnSbPLm0wh2mWFosu5vtSSiOdBriA=', N'photo.jpg', 1)\r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (2, N'Mohsen Shamas', N'mrayjeh', N'deleted', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N'eue3Mvuwue+WEmZI1nCI/hF8NNuvp2jRFX6UrLVIhgo=', N'photo.jpg', 0)\r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (3, N'Mohsen Shamas', N'Mrayjeh', N'Mohsen', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N'eue3Mvuwue+WEmZI1nCI/hF8NNuvp2jRFX6UrLVIhgo=', N'photo.jpg', 1)\r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (4, N'ali anani', N'leb, bei', N'ali@1', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N'YJvSJxUAXQYo0ryvql1XdHc+xYGFPnDIrucVT06AzH8=', N'photo.jpg', 1)\r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (5, N'Ali Haidar', N'old road', N'ali', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N'eue3Mvuwue+WEmZI1nCI/hF8NNuvp2jRFX6UrLVIhgo=', N'photo.jpg', 1)\r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (1004, N'Akram', N'old road', N'akr', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N'TkVG+K79vF5JgyMnBO2j5H6StcDvw7ywMa5d8mKgNBo=', N'photo.jpg', 1)\r\nGO\r\nINSERT [dbo].[Clients] ([ClientID], [FullName], [Address], [Username], [Password], [CreditCardNumber], [ImagePath], [IsActive]) VALUES (1005, N'Akram', N'old road', N'akrm', N'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', N'eue3Mvuwue+WEmZI1nCI/hF8NNuvp2jRFX6UrLVIhgo=', N'photo.jpg', 1)\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Clients] OFF\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Items] ON \r\nGO\r\nINSERT [dbo].[Items] ([ItemID], [CategoryID], [Name], [Description], [ImagePath], [Price], [Stock], [Discount]) VALUES (1, 1, N'Black Tshirt', N'100% Cotton', N'black tshirt.jpg', 10.0000, 6, CAST(0.10 AS Decimal(3, 2)))\r\nGO\r\nINSERT [dbo].[Items] ([ItemID], [CategoryID], [Name], [Description], [ImagePath], [Price], [Stock], [Discount]) VALUES (2, 1, N'Red Tshirt', N'100% Cotton', N'red tshirt.jpg', 10.0000, 9, CAST(0.00 AS Decimal(3, 2)))\r\nGO\r\nINSERT [dbo].[Items] ([ItemID], [CategoryID], [Name], [Description], [ImagePath], [Price], [Stock], [Discount]) VALUES (3, 1, N'White Tshirt', N'100% Cotton', N'tshirt.jpeg', 10.0000, 0, CAST(0.00 AS Decimal(3, 2)))\r\nGO\r\nINSERT [dbo].[Items] ([ItemID], [CategoryID], [Name], [Description], [ImagePath], [Price], [Stock], [Discount]) VALUES (4, 2, N'Airpods', N'Original,Made in USA', N'airpods.jpg', 100.0000, 9, CAST(0.10 AS Decimal(3, 2)))\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Items] OFF\r\nGO\r\nSET IDENTITY_INSERT [dbo].[OrderDetails] ON \r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (1, 5, 4, 2, 180.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (2, 6, 4, 2, 180.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (3, 7, 1, 2, 18.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (4, 8, 4, 2, 180.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (5, 9, 4, 2, 180.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (8, 12, 1, 1, 9.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (9, 13, 1, 1, 9.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (10, 14, 1, 1, 9.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (11, 15, 4, 1, 90.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (12, 16, 1, 1, 9.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (13, 17, 1, 1, 9.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (14, 17, 2, 1, 10.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (15, 18, 1, 2, 18.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (16, 19, 4, 1, 90.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (17, 19, 1, 2, 18.0000)\r\nGO\r\nINSERT [dbo].[OrderDetails] ([OrderDetailID], [OrderID], [ItemID], [Quantity], [TotalPrice]) VALUES (1015, 1018, 2, 1, 10.0000)\r\nGO\r\nSET IDENTITY_INSERT [dbo].[OrderDetails] OFF\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Orders] ON \r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (5, 1, CAST(N'2024-12-29T10:47:59.183' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (6, 1, CAST(N'2024-12-29T10:48:45.803' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (7, 1, CAST(N'2024-12-29T10:56:29.120' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (8, 1, CAST(N'2024-12-29T10:59:10.767' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (9, 1, CAST(N'2024-12-29T12:01:31.907' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (10, 1, CAST(N'2024-12-29T12:05:53.997' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (11, 1, CAST(N'2024-12-29T12:07:57.603' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (12, 1, CAST(N'2024-12-29T12:11:07.950' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (13, 1, CAST(N'2024-12-29T13:18:52.957' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (14, 1, CAST(N'2024-12-29T13:23:32.050' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (15, 1, CAST(N'2024-12-29T13:41:44.423' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (16, 1, CAST(N'2024-12-29T13:42:55.490' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (17, 1, CAST(N'2024-12-29T13:44:18.083' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (18, 1, CAST(N'2024-12-30T15:57:35.487' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (19, 5, CAST(N'2025-01-01T13:53:52.743' AS DateTime))\r\nGO\r\nINSERT [dbo].[Orders] ([OrderID], [ClientID], [Date]) VALUES (1018, 1005, CAST(N'2025-01-19T22:13:58.940' AS DateTime))\r\nGO\r\nSET IDENTITY_INSERT [dbo].[Orders] OFF\r\nGO\r\nALTER TABLE [dbo].[Items]  WITH CHECK ADD  CONSTRAINT [FK__Items__CategoryI__3B75D760] FOREIGN KEY([CategoryID])\r\nREFERENCES [dbo].[Categories] ([CategoryID])\r\nGO\r\nALTER TABLE [dbo].[Items] CHECK CONSTRAINT [FK__Items__CategoryI__3B75D760]\r\nGO\r\nALTER TABLE [dbo].[OrderDetails]  WITH CHECK ADD  CONSTRAINT [FK__OrderDeta__ItemI__4222D4EF] FOREIGN KEY([ItemID])\r\nREFERENCES [dbo].[Items] ([ItemID])\r\nGO\r\nALTER TABLE [dbo].[OrderDetails] CHECK CONSTRAINT [FK__OrderDeta__ItemI__4222D4EF]\r\nGO\r\nALTER TABLE [dbo].[OrderDetails]  WITH CHECK ADD  CONSTRAINT [FK__OrderDeta__Order__412EB0B6] FOREIGN KEY([OrderID])\r\nREFERENCES [dbo].[Orders] ([OrderID])\r\nGO\r\nALTER TABLE [dbo].[OrderDetails] CHECK CONSTRAINT [FK__OrderDeta__Order__412EB0B6]\r\nGO\r\nALTER TABLE [dbo].[Orders]  WITH CHECK ADD  CONSTRAINT [FK__Orders__ClientID__3E52440B] FOREIGN KEY([ClientID])\r\nREFERENCES [dbo].[Clients] ([ClientID])\r\nGO\r\nALTER TABLE [dbo].[Orders] CHECK CONSTRAINT [FK__Orders__ClientID__3E52440B]\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_AddCategory]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\n\r\nCREATE procedure [dbo].[SP_AddCategory]\r\n@Name nvarchar(50),\r\n@NewID int output\r\nas\r\nbegin\r\n\r\nbegin try\r\ninsert into Categories values (@Name);\r\n\r\nif(@@IDENTITY is not null)\r\nbegin\r\nset @NewID=@@IDENTITY;\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_AddClient]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE procedure [dbo].[SP_AddClient]\r\n@FullName nvarchar(50),\r\n@Address nvarchar(MAX),\r\n@Username nvarchar(30),\r\n@Password nvarchar(max),\r\n@CreditCardNumber nvarchar(MAX),\r\n@ImagePath nvarchar(MAX),\r\n@NewID int output\r\nas\r\nbegin\r\n\r\nbegin try\r\nInsert into clients values\r\n(@FullName,@Address,@Username,@Password,@CreditCardNumber,@ImagePath,1);\r\n\r\nif(@@IDENTITY is not null)\r\nbegin\r\nset @NewID=@@identity;\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\n\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_AddItem]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE procedure [dbo].[SP_AddItem]\r\n@CategoryID int,\r\n@Name nvarchar(50),\r\n@Description nvarchar(MAX),\r\n@ImagePath nvarchar(MAX),\r\n@Price smallmoney,\r\n@Stock int,\r\n@Discount decimal(3,2),\r\n@NewID int output\r\nas\r\nbegin\r\n\r\nbegin try\r\nInsert into items values(@CategoryID,@Name,@Description,@ImagePath,@Price,@Stock,@Discount);\r\n\r\nif(@@IDENTITY is not null)\r\nbegin\r\nset @NewID=@@IDENTITY;\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_AddOrder]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE procedure [dbo].[SP_AddOrder]\r\n@clientid int,\r\n@NewID int output\r\nas\r\nbegin\r\n\r\nbegin try\r\ninsert into Orders values(@clientid,GETDATE());\r\n\r\nif(@@IDENTITY is not null)\r\nbegin\r\nset @NewID=@@identity\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_AddOrderDetail]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\nCREATE procedure [dbo].[SP_AddOrderDetail]\r\n@orderid int,\r\n@itemid int,\r\n@quantity int,\r\n@totalprice smallmoney\r\nas\r\nbegin\r\n\r\nbegin transaction\r\n\r\nbegin try\r\n\r\ninsert into OrderDetails values(@orderid,@itemid,@quantity,@totalprice)\r\n\r\nif((select stock from Items where ItemID=@itemid)-@quantity<0)\r\nbegin\r\nrollback\r\nreturn 0;\r\nend\r\n\r\nelse\r\nbegin\r\n\r\n\r\n\r\nupdate items\r\nset Stock=Stock-@quantity where ItemID=@itemid\r\n\r\nif(@@ROWCOUNT>0)\r\nbegin\r\ncommit\r\nend\r\n\r\nelse\r\nbegin\r\nrollback\r\nend\r\n\r\nend\r\nend try\r\nbegin catch\r\nrollback\r\nend catch\r\nend  \r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_DeleteClient]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE procedure [dbo].[SP_DeleteClient]\r\n@clientid int\r\nas\r\nbegin\r\n\r\nbegin try\r\ndelete from clients where clientid=@clientid\r\n\r\nif(@@ROWCOUNT>0)\r\nbegin\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_FindCategoryByID]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\n\r\nCREATE procedure [dbo].[SP_FindCategoryByID]\r\n@Name nvarchar(50) output,\r\n@CategoryID int \r\nas\r\nbegin\r\n\r\nbegin try\r\nif exists(select 1 from Categories where CategoryID=@CategoryID)\r\nbegin\r\nselect @Name=Name from Categories where CategoryID=@CategoryID;\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\n\r\n\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_FindClientByID]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE procedure [dbo].[SP_FindClientByID]\r\n@ClientID int,\r\n@FullName nvarchar(50) output,\r\n@Address nvarchar(MAX) output,\r\n@Username nvarchar(30) output,\r\n@Password nvarchar(max) output,\r\n@CreditCardNumber nvarchar(MAX) output,\r\n@ImagePath nvarchar(MAX) output,\r\n@IsActive bit output\r\nas\r\nbegin\r\n\r\nbegin try\r\nif exists(select 1 from clients where ClientID=@ClientID)\r\nbegin\r\nselect @FullName=fullname,@Address=address,@Username=username,@Password=password,\r\n@CreditCardNumber=creditcardnumber,@ImagePath=imagepath,@IsActive=isactive from clients where clientid=@ClientID\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\n\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_FindClientByUsernameAndPassword]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE procedure [dbo].[SP_FindClientByUsernameAndPassword]\r\n@ClientID int output,\r\n@FullName nvarchar(50) output,\r\n@Address nvarchar(MAX) output,\r\n@Username nvarchar(30),\r\n@Password nvarchar(max),\r\n@CreditCardNumber nvarchar(MAX) output,\r\n@ImagePath nvarchar(MAX) output,\r\n@IsActive bit output\r\nas\r\nbegin\r\n\r\nbegin try\r\nif exists(select 1 from clients where Username=@Username and Password=@Password)\r\nbegin\r\nselect @ClientID=clientid,@FullName=fullname,@Address=address,\r\n@CreditCardNumber=creditcardnumber,@ImagePath=imagepath,@IsActive=isactive \r\nfrom clients where Username=@Username and Password=@Password;\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\n\r\n\r\n\r\n\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_FindItemByID]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE procedure [dbo].[SP_FindItemByID]\r\n@CategoryID int output,\r\n@Name nvarchar(50) output,\r\n@Description nvarchar(MAX) output,\r\n@ImagePath nvarchar(MAX) output,\r\n@Price smallmoney output,\r\n@Stock int output,\r\n@Discount decimal(3,2) output,\r\n@ItemID int\r\nas\r\nbegin\r\n\r\nbegin try\r\n\r\nif exists(select 1 from items where itemid=@ItemID)\r\nbegin\r\nselect @name=name,@CategoryID=categoryid,@Description=Description,@ImagePath=ImagePath,@Price=Price,@stock=Stock,@Discount=Discount\r\nfrom Items where itemid=@ItemID\r\nend\r\n\r\n\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nreturn 1;\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_ListCategories]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE procedure [dbo].[SP_ListCategories]\r\nas\r\nbegin\r\nbegin try\r\nSelect Name from Categories order by CategoryID\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\nreturn 1;\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_ListClients]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\nCREATE procedure [dbo].[SP_ListClients]\r\n@PageNumber int\r\nas\r\nbegin\r\nif(@PageNumber<=0)\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nselect c.ClientID,c.FullName,LastPurchaseDate= case when exists(select top 1 date from orders where orders.clientid=c.clientid\r\n order by date desc) then(select top 1 date from orders where orders.clientid=c.clientid\r\n order by date desc) else 'None' end,Status=case c.isactive when 1 then 'Active' else 'Inactive' end from clients c order by c.IsActive desc\r\n offset (@pagenumber-1)*10 rows\r\n fetch next 10 rows only\r\n\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_ListItems]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE procedure [dbo].[SP_ListItems]\r\n@PageNumber int,\r\n@CategoryName nvarchar(50),\r\n@Name nvarchar(50)\r\nas\r\nbegin\r\nselect ItemID,Categories.Name,items.Name,Description,ImagePath,Price,Stock,Discount\r\nfrom items join Categories on Categories.CategoryID=Items.CategoryID\r\n\r\nwhere Categories.Name \r\nlike case @CategoryName \r\nwhen 'ALL' then '%' \r\nelse @CategoryName end\r\nand\r\nItems.Name like '%'+@Name + '%'\r\n\r\norder by Items.Name\r\noffset (@PageNumber-1)*9 rows\r\n fetch next 9 rows only\r\n\r\n\r\n end\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_ListOrderDetails]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\ncreate procedure [dbo].[SP_ListOrderDetails]\r\n@orderid int\r\nas\r\nbegin\r\n\r\nbegin try\r\nselect items.ItemID,Items.Name,OrderDetails.Quantity,OrderDetails.TotalPrice\r\nfrom OrderDetails join Items on OrderDetails.ItemID=Items.ItemID\r\nwhere OrderDetails.OrderID=@orderid\r\nreturn 1;\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_ListOrders]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\nCREATE procedure [dbo].[SP_ListOrders]\r\n@ClientID int,\r\n@PageNumber int\r\nas\r\nbegin\r\n\r\nselect Orders.OrderID,Clients.FullName,Orders.Date,\r\nTotalPrice=(select sum(totalprice) from OrderDetails where Orderid=orders.orderid)\r\nfrom Orders join Clients on Orders.ClientID=Clients.ClientID\r\nwhere @ClientID=-1 or Orders.ClientID=@ClientID\r\norder by orders.Date desc\r\noffset (@PageNumber-1)*9 rows\r\nfetch next 9 rows only\r\n\r\n\r\n\r\nend\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_UpdateClient]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE procedure [dbo].[SP_UpdateClient]\r\n@FullName nvarchar(50),\r\n@Address nvarchar(MAX) ,\r\n@Username nvarchar(30) ,\r\n@Password nvarchar(max) ,\r\n@CreditCardNumber nvarchar(MAX) ,\r\n@ImagePath nvarchar(MAX) ,\r\n@IsActive bit ,\r\n@ClientID int\r\nas\r\nbegin\r\n\r\nbegin try\r\n\r\nupdate clients set\r\nfullname=@FullName,address=@Address,username=@Username,password=@Password,\r\ncreditcardnumber=@CreditCardNumber,imagepath=@ImagePath,isactive=@IsActive\r\nfrom clients where clientid=@ClientID\r\nreturn 1;\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\n\r\n\r\nend\r\n\r\nGO\r\n/****** Object:  StoredProcedure [dbo].[SP_UpdateItem]    Script Date: 6/17/2025 2:40:52 PM ******/\r\nSET ANSI_NULLS ON\r\nGO\r\nSET QUOTED_IDENTIFIER ON\r\nGO\r\n\r\n\r\nCREATE procedure [dbo].[SP_UpdateItem]\r\n@CategoryID int,\r\n@Name nvarchar(50),\r\n@Description nvarchar(MAX),\r\n@ImagePath nvarchar(MAX),\r\n@Price smallmoney,\r\n@Stock int,\r\n@Discount decimal(3,2),\r\n@ItemID int\r\nas\r\nbegin\r\n\r\nbegin try\r\n\r\nupdate items\r\nset name=@name,Description=@Description,ImagePath=@ImagePath,Price=@Price,stock=@Stock,Discount=@Discount\r\nwhere ItemID=@ItemID\r\n\r\nend try\r\nbegin catch\r\nreturn 0\r\nend catch\r\nif(@@ROWCOUNT>0)\r\nbegin\r\nreturn 1;\r\nend\r\n\r\nelse\r\nbegin\r\nreturn 0;\r\nend\r\n\r\nend\r\nGO\r\nUSE [master]\r\nGO\r\nALTER DATABASE [Abjad] SET  READ_WRITE \r\nGO\r\n";
                using (SqlConnection masterConnection = new SqlConnection(ConfigurationManager.ConnectionStrings["ConnectionStringMaster"].ConnectionString))
                {
                    masterConnection.Open();

                    object result = new SqlCommand(query, masterConnection).ExecuteScalar();

                    if (result == null) // DB does NOT exist
                    {
                        // Create the database
                        string[] batches = Regex.Split(createDbScript, @"^\s*GO\s*$", RegexOptions.Multiline | RegexOptions.IgnoreCase);
                        foreach (string batch in batches)
                        {
                            if (!string.IsNullOrWhiteSpace(batch))
                            {
                                using (SqlCommand cmd = new SqlCommand(batch, masterConnection))
                                {
                                    cmd.ExecuteNonQuery();
                                }
                            }
                        }

                        // Run post creation script in new DB
                        using (SqlConnection DVLDConnection = new SqlConnection(ConfigurationManager.ConnectionStrings["ConnectionString"].ConnectionString))
                        {
                            DVLDConnection.Open();
                            string[] batches2 = Regex.Split(postCreationScript, @"^\s*GO\s*$", RegexOptions.Multiline | RegexOptions.IgnoreCase);
                            foreach (string batch in batches2)
                            {
                                if (!string.IsNullOrWhiteSpace(batch))
                                {
                                    using (SqlCommand cmd = new SqlCommand(batch, DVLDConnection))
                                    {
                                        cmd.ExecuteNonQuery();
                                    }
                                }
                            }
                        }

                        return true; // DB created and scripts run
                    }
                    else
                    {
                        return false; // DB exists, nothing done
                    }
                }
            }


        }
    }


